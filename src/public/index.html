<!DOCTYPE html>
<html lang="en">
	<head>
	<meta charset="UTF-8" />
	<title>Housing JSON Data Viewer</title>
	<style>
		body {
		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		background: #eef2f5;
		color: #333;
		margin: 0;
		padding: 0;
		}
		header {
		background-color: #45787c;
		color: white;
		padding: 20px 0;
		text-align: center;
		box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		margin-bottom: 20px;
		}
		.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
		overflow-x: auto;
		}
		table {
		width: 100%;
		border-collapse: collapse;
		margin-bottom: 30px;
		}
		th, td {
		padding: 10px;
		border: 1px solid #ccc;
		}
		th {
		background-color: #3498db;
		color: white;
		}
		tr:hover {
		background-color: #f1f1f1;
		}
		.button-group, .action-bar {
		display: flex;
		flex-wrap: wrap;
		gap: 10px;
		margin-bottom: 20px;
		}
		.button-group button, .action-bar button,
		td button {
		padding: 6px 12px;
		border: none;
		border-radius: 4px;
		font-size: 0.9em;
		cursor: pointer;
		transition: background-color 0.2s;
		}
		.edit-button { background-color: #27ae60; color: white; }
		.edit-button:hover { background-color: #219150; }
		.delete-button { background-color: #c0392b; color: white; }
		.delete-button:hover { background-color: #a93226; }
		.download-button { background-color: #f39c12; color: white; }
		.download-button:hover { background-color: #d78b0c; }
		.primary-button {
		padding: 10px 16px;
		border-radius: 6px;
		background-color: #3498db;
		color: white;
		border: none;
		cursor: pointer;
		font-weight: bold;
		}
		.primary-button:hover { background-color: #2980b9; }
		form {
		margin-bottom: 40px;
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
		gap: 16px;
		align-items: end;
		}
		form label { font-weight: 600; }
		form input, form select {
		padding: 6px 8px;
		border: 1px solid #ccc;
		border-radius: 4px;
		font-size: 0.9em;
		width: 100%;
		margin-top: 4px;
		}
		form small {
		display: block;
		color: #666;
		margin-top: 4px;
		font-size: 0.8em;
		}
		#query-status {
		color: #444;
		margin-top: 8px;
		}
	</style>
	</head>
	<body>
	<header>
		<h1>Housing JSON Records Viewer</h1>
	</header>

	<div class="container action-bar">
		<button class="primary-button" onclick="fetchAll()">üîç View All</button>
		<button class="primary-button" onclick="scrollToForm()">üß† Run JSON/Dot Query</button>
		<button class="primary-button" onclick="showCreateForm()">‚ûï Create Record</button>
		<button class="primary-button" onclick="uploadBulk()">üì• Bulk Upload</button>
	</div>

	<div class="container">
		<h2>üîç Run a Custom JSON Housing Query</h2>
		<form id="query-form">
		<div>
			<label for="queryType">Query Type:</label>
			<select name="queryType" id="queryType">
			<option value="jq">JSON Query (json_query)</option>
			<option value="dot">Dot Notation</option>
			</select>
			<small>Choose between Oracle's JSON_QUERY or dot access.</small>
		</div>
		<div>
			<label for="select">Select Fields:</label>
			<input type="text" name="select" id="select" placeholder="e.g., Dimensions.Value,CSDUID" required />
			<small>Comma-separated fields to return.</small>
		</div>
		<div>
			<label for="where">Where Field:</label>
			<input type="text" name="where" id="where" placeholder="e.g., CSD" required />
			<small>JSON key to apply the filter on.</small>
		</div>
		<div>
			<label for="value">Value:</label>
			<input type="text" name="value" id="value" placeholder="e.g., Red Deer" required />
			<small>Value to match (supports % for wildcard).</small>
		</div>
		<div style="display: flex; align-items: center; gap: 8px;">
			<input type="checkbox" name="string" id="string" />
			<label for="string" style="margin: 0;">Use LIKE (string match)</label>
		</div>
		<div style="align-self: end;">
			<button type="submit" style="padding: 8px 16px;">Run Query</button>
		</div>
		</form>
		<p id="query-status"></p>
	</div>

	<div class="container" id="data-container">Loading data...</div>

	<script>
		const form = document.getElementById("query-form");
		const status = document.getElementById("query-status");

		function scrollToForm() {
		form.scrollIntoView({ behavior: 'smooth' });
		}

		form.addEventListener("submit", async function (e) {
		e.preventDefault();
		const formData = new FormData(form);
		const queryType = formData.get("queryType");
		const select = formData.get("select");
		const where = formData.get("where");
		const value = formData.get("value");
		const isString = formData.get("string") ? "true" : "false";
		const params = new URLSearchParams({ select, where, value, string: isString });
		const endpoint = `/housing/${queryType}?${params.toString()}`;

		try {
			status.textContent = "Running query...";
			const resp = await fetch(endpoint);
			if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
			const result = await resp.json();
			renderTable(result.data || []);
			status.textContent = `‚úÖ Found ${result.count || 0} result(s).`;
		} catch (err) {
			console.error("Query failed:", err);
			document.getElementById("data-container").textContent = "Failed to load data.";
			status.textContent = "‚ùå Query failed. See console for details.";
		}
		});

		async function fetchAll() {
		const res = await fetch('/housing');
		const json = await res.json();
		renderTable(json.data || []);
		}

		function renderTable(data) {
		const container = document.getElementById("data-container");
		container.innerHTML = '';
		const table = document.createElement('table');
		const thead = document.createElement('thead');
		thead.innerHTML = `
			<tr>
			<th>Record ID</th>
			<th>CSDUID</th>
			<th>CSD</th>
			<th>Period</th>
			<th>Indicator</th>
			<th>Housing Type</th>
			<th>Original Value</th>
			<th>Actions</th>
			</tr>
		`;
		table.appendChild(thead);
		const tbody = document.createElement('tbody');
		data.forEach(record => {
			let id = record.id;
			let json = record.jsonData;
			if (!json && !id) { json = record; id = '‚Äì'; }
			const tr = document.createElement('tr');
			tr.innerHTML = `
			<td>${id}</td>
			<td>${json?.CSDUID || ''}</td>
			<td>${json?.CSD || ''}</td>
			<td>${json?.Period || ''}</td>
			<td>${json?.IndicatorSummaryDescription || ''}</td>
			<td>${json?.Dimensions?.[0]?.Value || ''}</td>
			<td style="text-align: right;">${json?.OriginalValue || ''}</td>
			<td style="text-align: center;">
				<button class="edit-button">Edit</button>
				<button class="delete-button">Delete</button>
				<button class="download-button">Download</button>
			</td>
			`;
			tbody.appendChild(tr);
		});
		table.appendChild(tbody);
		container.appendChild(table);
		}

		function showCreateForm() {
		alert("üöß Create Record form not yet implemented. You can POST to /housing using your API tools.");
		}

		function uploadBulk() {
		alert("üöß Bulk upload not yet implemented in UI. Please POST to /housing/bulk using your API tools.");
		}

		fetchAll(); // Initial load
	</script>
</body>
</html>